<?xml version="1.0" encoding="utf-8"?>
<Dashboard>
  <Title Text="Prodaja" />
  <DataSources>
    <SqlDataSource Name="CustomSqlQuery" ComponentName="sqlDataSource1">
      <Connection Name="PetPak" FromAppConfig="true" />
      <Query Type="CustomSqlQuery" Name="CustomSqlQuery">
        <Sql>SELECT
			mo.ackDoc									AS ProdajaŠtevilkaDokumenta,
			mo.adDate									AS ProdajaDatumDokumenta,						--	Datum,
			mo.ackDocType+' '+ISNULL(sdt.acName,'Nepoimenovano')	AS ProdajaPoslovniDogodek,	--	Poslovni dogodek
			CASE 
					WHEN mo.ackDocType in ('3000','3030','3035','3040','3050','3055','3100','3200','3600','3610','3620','3700','3900','3930','OB00')	THEN 'Domači trg'
					WHEN mo.ackDocType in ('3010','3060','3065','3110','3910','3940')																																	THEN 'Prodaja EU'
					WHEN mo.ackDocType in ('3020','3070','3075','3120','3920','3950')																																	THEN 'Izvoz'
																																																																						ELSE 'Nedefinirano v QV' 
			END												AS ProdajaVrstaPrometa,							--	VrstaPrometa,
			DATEPART(YEAR,mo.adDate)	AS ProdajaLeto,											--	Leto, 
			DATEPART(MONTH,mo.adDate)	AS ProdajaMesec,										--	Mesec, 
			DATEPART(WEEK,mo.adDate)	AS ProdajaTeden,										--	Teden,
			DATEPART(DAY,mo.adDate)		AS ProdajaDan,											--	Dan,
			CASE
					WHEN  DATEPART(MONTH,mo.adDate) &lt;=3	THEN 'Q1'
					WHEN  DATEPART(MONTH,mo.adDate) &lt;=6	THEN 'Q2'
					WHEN  DATEPART(MONTH,mo.adDate) &lt;=9	THEN 'Q3'
																							ELSE 'Q4'
			END												AS ProdajaKvartal,
			mo.acnBuyer								AS ProdajaKupec,										--	Prejemnik, 
			UPPER(ss.acCountry)				AS ProdajaKupecDržava,							--	Drzava, 
			UPPER(ISNULL(spc.acRegion,''))	AS ProdajaKupecRegija, 
			CASE
					WHEN ISNULL(ss.acFieldSI,'')!=''				THEN ss.acFieldSI
					WHEN ISNULL(ss.acPayer,'')!=''					THEN ss.acPayer
					WHEN ISNULL(ss.acNaturalPerson,'')='T'	THEN 'PLASTIKA SKAZA D.O.O.'
																									ELSE ss.acSubject
			END												AS ProdajaKupecPlačnik,							--	Kupec,		Popravil 14-5-2019 iz plačnika na nadrejenega kupcaiz poljubnih polj
			si.acIdent								AS ProdajaIdent,										--	dodano polje
			si.acName									AS ProdajaIdentNaziv,								--	dodano polje
			RTRIM(si.acident)+'-'+si.acname	AS ProdajaIdentInNaziv,				--	Izdelek 
			si.acSetOfItem+' '+ISNULL(sit.acName,'Nepoimenovano')	AS ProdajaVrstaMaterialnegaSredstva,	--Vrsta materialnega sredstva
			CASE
					 WHEN ISNULL(si.acClassif2,'')=''	THEN ''
																						ELSE RTRIM(ISNULL(si.acClassif2,''))+'-'+ISNULL(sics.acName,'') 
			END												AS ProdajaSekundarnaKlasifikacija,	--	Sekundarna Klasifikacija
			CASE
					WHEN ISNULL(si.acClassif,'')=''	THEN ''
																					ELSE RTRIM(ISNULL(si.acClassif,''))+'-'+ISNULL(sicp.acName,'') 
			END												AS ProdajaPrimarnaKlasifikacija,		--	Primarna Klasifikacija
			SUM(ISNULL(moi.anvQty,0))																																				AS ProdajaKoličinaPodaja,	--anQty,
			SUM((ISNULL(moi.anvSalePrice,0)*ISNULL(moi.anvQty,0)))																					AS ProdajaProdajnaVrednost,	--prodaja, 
			SUM((ISNULL(moi.anvStockPrice,0)*ISNULL(moi.anvQty,0)))																					AS ProdajaNabavnaVrednost,	--nabava, 
			ISNULL(us.acTitle,'Ni definiran')																																AS ProdajaSkrbnik
--	INTO utn_AnalitikaProdajaRealizacija
FROM tZE_SalesMove mo (NOLOCK)
JOIN tZE_SalesMoveItem moi on (mo.ackdoc=moi.ackdoc)
JOIN tHE_SetItem si (nolock) on (moi.ackitem=si.acIdent)
JOIN dbo.tHE_SetItemType sit (NOLOCK) ON si.acSetOfItem=sit.acSetOfItem
JOIN tPA_SetDocType sdt (NOLOCK) ON mo.ackDocType=sdt.acDocType
left join tHE_SetItemCateg  sics (nolock) on (si.acClassif2=sics.acClassif)
left join tHE_SetItemCateg  sicp (nolock) on (si.acClassif=sicp.acClassif)
left join tHE_SetSubj  ss (nolock) on (mo.acnBuyer=ss.acSubject)
LEFT JOIN tHE_SetPostCode spc (nolock) on (ss.acPost=spc.acPost)
LEFT JOIN tpa_user us ON ss.anclerk=us.anuserid
WHERE mo.ackdoc NOT LIKE '%x'
GROUP by	mo.ackdoc, mo.ackDocType, mo.adDate, si.acSetOfItem, si.acClassif,sics.acName,sicp.acName,ss.acCountry,spc.acRegion, ss.acFieldSI,
					ss.acPayer, ss.acSubject, ss.acNaturalPerson, si.acident, si.acname, mo.acnBuyer, si.acClassif2, sit.acName, sdt.acName, us.acTitle;</Sql>
      </Query>
      <ConnectionOptions CloseConnection="true" />
    </SqlDataSource>
  </DataSources>
</Dashboard>